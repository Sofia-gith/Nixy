<%- include('partials/header', { title: 'Página Inicial' }) %>
    <div class="layout-comunidade">

        <%- include('partials/menuComuni', { comunidades: comunidades }) %>

            <main>
                <div class="container-comunidade">
                    <%- include('partials/BarraDeBusca') %>

                        <!-- Banner da Comunidade com cabeçalho sobreposto -->
                        <div class="banner-container">
                            <div class="banner-comunidade">
                                <span class="texto-banner">Aqui poderá uppar uma imagem</span>
                                <button class="btn-upload"><img src="/imagens/camera.png" alt="Upload"></button>

                                <!-- Cabeçalho sobre o banner -->
                                <div class="cabecalho-comunidade">
                                    <div class="avatar"></div>
                                    <h2 class="nome-comunidade">
                                        <%= comunidade.NOME_COMUNIDADE_T14 %>
                                    </h2>

                                    <% if (comunidade.is_criador || comunidade.is_moderador) { %>
                                        <div class="moderador-acoes">
                                            <button id="btnDeletarComunidade" class="btn-moderador">
                                                <img src="/imagens/lixo.png" alt="Deletar Comunidade">
                                            </button>
                                            <% if (comunidade.is_criador) { %>
                                                <button id="btnGerenciarModeradores" class="btn-moderador">
                                                    <img src="/imagens/adicionarMod.png" alt="Gerenciar Moderadores">
                                                </button>
                                                <% } %>
                                        </div>
                                        <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Posts -->
                        <% if (posts.length> 0) { %>
                            <% posts.forEach(post=> { %>
                                <div class="post">
                                    <div class="info-usuario">
                                        <div class="avatar"
                                            style="background-image: url('<%= post.autor_foto ? `${post.autor_foto}?v=${Date.now()}` : '/img/default.png' %>');"
                                            data-user-id="<%= post.autor_id %>">
                                        </div>
                                        <span class="nome-usuario">
                                            <%= post.nomeUsuario %>
                                        </span>
                                    </div>
                                    <h3 class="titulo-post">
                                        <%= post.titulo %>
                                    </h3>
                                    <div class="conteudo-post">
                                        <p>
                                            <%- post.conteudo %>
                                        </p>
                                    </div>
                                    <div class="acoesPost">
                                        <button class="btn-avaliacao-positivo">
                                            <img class="avaliarBtn" src="/imagens/gostar.png" alt="">
                                            <span id="likes">
                                                <%= post.likes || 0 %>
                                            </span>
                                        </button>
                                        <button class="btn-avaliacao-negativo">
                                            <img class="avaliarBtn" src="/imagens/nao-gosto.png" alt="">
                                            <span id="dislikes">
                                                <%= post.dislikes || 0 %>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                <% }); %>
                                    <% } else { %>
                                        <div class="sem-posts">
                                            <p>Nenhum post encontrado nesta comunidade. Seja o primeiro a postar!</p>
                                        </div>
                                        <% } %>

                                            <!-- Botão Flutuante para Criar Post -->
                                            <button class="botao-flutuante">＋</button>
                </div>
            </main>
    </div>

    <script>
        console.log('Dados da comunidade:', <%= JSON.stringify(comunidade) %>);
    </script>

    <script>
        document.getElementById('btnDeletarComunidade')?.addEventListener('click', async () => {
            const comunidadeId = '<%= comunidade.ID_COMUNIDADE_T14 %>';
            console.log('[FRONT] Iniciando processo de deleção para comunidade:', comunidadeId);

            const confirmacao = confirm('Tem certeza que deseja deletar esta comunidade? Esta ação não pode ser desfeita.');
            if (!confirmacao) {
                console.log('[FRONT] Deleção cancelada pelo usuário');
                return;
            }

            try {
                console.log('[FRONT] Enviando requisição DELETE...');
                const response = await fetch(`/comunidade/${comunidadeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                console.log('[FRONT] Resposta recebida - Status:', response.status);
                const data = await response.json();
                console.log('[FRONT] Dados da resposta:', data);

                if (!response.ok) {
                    throw new Error(data.erro || 'Erro ao deletar comunidade');
                }

                alert('Comunidade deletada com sucesso!');
                console.log('[FRONT] Redirecionando para /comunidades...');
                window.location.href = '/comunidades';
            } catch (error) {
                console.error('[FRONT] Erro completo:', error);
                alert(`Erro: ${error.message}`);

                if (error.message.includes('não encontrada')) {
                    console.log('[FRONT] Recarregando página...');
                    window.location.reload();
                }
            }
        });
    </script>
    </body>

    </html>